# /batch-trend-analysis - Analyze Batch Performance Trends

Run trend analysis on completed batch metrics to identify bottlenecks and optimization opportunities.

## Usage

```bash
# Analyze recent 5 batches (default)
/batch-trend-analysis

# Analyze specific number of recent batches
/batch-trend-analysis --recent 10

# Analyze all completed batches
/batch-trend-analysis --all

# With verbose output
/batch-trend-analysis --recent 5 --verbose
```

## Purpose

Generate trend reports to identify:
- **Bottlenecks**: Slowest operations, highest failure rates, excessive token usage
- **Patterns**: Average duration by operation type, success rates, cost trends
- **Recommendations**: Data-driven prioritization for Phase 2 improvements

## Options

| Option | Description | Default |
|--------|-------------|---------|
| `--recent N` | Analyze last N batches | 5 |
| `--all` | Analyze all completed batches | - |
| `--verbose` | Show detailed breakdown | false |
| `--output <path>` | Save report to file | stdout |

## Output Format

Report includes:
- **Summary Statistics**: Mean/median/stdev by operation
- **Bottleneck Analysis**: Top 3 slowest operations, highest costs, failure rates
- **Trend Patterns**: Success rates, average tokens, cost per operation
- **Recommendations**: Prioritized improvements based on impact

## Example Output

```
Batch Trend Analysis Report
===========================

Analysis Scope: Last 5 batches

DURATION TRENDS (seconds)
Operation           Mean    Median  StDev   Min     Max
generate            180.5   175.0   12.3    165     198
execute             450.2   445.0   25.4    420     490
review              240.1   235.0   18.2    215     275
update-context      45.3    42.0    8.1     35      62

BOTTLENECK ANALYSIS
Critical Issues:
  - Execute operation: 450s avg (HIGH - focus for optimization)
  - Review operation: 240s avg (MEDIUM - token optimization applied)

Success Rates:
  - Generate: 100%
  - Execute: 95% (1 failure in batch-45)
  - Review: 100%
  - Update-context: 100%

TOKEN USAGE TRENDS
Operation           Mean Tokens   Cost      Trend
generate            15,200        $0.30     ↓ stable
execute             45,600        $0.91     ↔ stable
review              32,100        $0.64     ↓ improving (shared context)
update-context      2,400         $0.05     ↔ stable

RECOMMENDATIONS (Priority Order)
1. [HIGH] Implement executor streaming (Phase 2)
   Impact: -40% time, -30% tokens
   Effort: 8 hours

2. [MEDIUM] Add LLM result caching (Phase 2)
   Impact: -20% time, -15% tokens
   Effort: 4 hours

3. [MEDIUM] Optimize review parallel efficiency (Phase 2)
   Impact: -15% time
   Effort: 3 hours
```

## Metrics Collected

Trend analysis uses metrics from `.ce/completed-batches/` containing:
- Duration (seconds)
- Token usage (input, output, total)
- Cost (USD)
- Success/failure counts
- Stage-specific breakdown
- Error categorization

## Metrics Schema

See: `.ce/schemas/batch-metrics.json`

Metrics are automatically generated by batch commands and stored in:
```
.ce/completed-batches/
├── batch-47-generate.json
├── batch-47-execute.json
├── batch-47-review.json
└── batch-47-update-context.json
```

## Workflow

**Typical Usage Pattern**:

```bash
# After running several batches (3-5+), analyze trends
/batch-trend-analysis --recent 5

# Review report for bottlenecks
# [Read output, identify patterns]

# Create Phase 2 PRPs based on top recommendations
/generate-prp PRPs/feature-requests/PHASE-2-PLAN.md

# Execute Phase 2 improvements
/batch-exe-prp --batch 48

# Collect more metrics
# [Run 5-10 more batches]

# Re-analyze to measure improvement
/batch-trend-analysis --recent 10
```

## System Restart Recovery

After system restart, run to resume metrics analysis:

```bash
# Quick check: Last batch status
/batch-trend-analysis --recent 1

# Full analysis: 10 most recent batches
/batch-trend-analysis --recent 10

# Complete history: All batches since Phase 1
/batch-trend-analysis --all
```

## Implementation

**Script**: `.ce/scripts/trend-analysis.py`
**Tool**: Python 3.8+ (stdlib only)
**Requirements**: None (no external dependencies)

**Command Flow**:
1. Parse arguments (--recent N | --all | --verbose)
2. Load metrics from `.ce/completed-batches/`
3. Calculate statistics (mean, median, stdev, min/max)
4. Identify bottlenecks (slow ops, high cost, low success)
5. Generate recommendations
6. Output report (stdout or file)

## Troubleshooting

**No metrics found?**
```bash
# Check if metrics directory exists
ls -la .ce/completed-batches/

# Run a batch to generate metrics
/batch-gen-prp PRPs/feature-requests/TEST-PLAN.md
```

**Script not found?**
```bash
# Verify script exists
ls -la .ce/scripts/trend-analysis.py

# Run directly
python .ce/scripts/trend-analysis.py --recent 5
```

**Permission denied?**
```bash
# Make script executable
chmod +x .ce/scripts/trend-analysis.py
```

## Related Commands

- `/batch-gen-prp` - Generate PRPs from plan
- `/batch-exe-prp` - Execute batch of PRPs
- `/batch-peer-review` - Review generated/executed PRPs
- `/batch-update-context` - Update PRP status with drift scores

## References

- **Phase 2 Decision Framework**: `PRPs/feature-requests/PRP-47-PHASE2-DECISION-FRAMEWORK.md`
- **Metrics Schema**: `.ce/schemas/batch-metrics.json`
- **Trend Analysis Script**: `.ce/scripts/trend-analysis.py`
- **Architecture Docs**: `.claude/orchestrators/README.md`
